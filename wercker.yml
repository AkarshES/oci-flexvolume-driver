box: golang:1.9
build:
  base-path: "/go/src/github.com/oracle/oci-flexvolume-driver"
  steps:
    - script:
      name: write VERSION.txt
      code: |
        git describe --always --dirty > ${WERCKER_OUTPUT_DIR}/VERSION.txt
        cat ${WERCKER_OUTPUT_DIR}/VERSION.txt

    - script:
      name: check boilerplate
      code: ./hack/verify-boilerplate.sh

    - script:
      name: go fmt
      code: make gofmt

    - script:
      name: build
      code: |
        make build
        make build-integration-tests

    - script:
      name: go vet
      code: make govet

    - script:
      name: unit tests
      code: make test

    - script:
      name: copy build artifacts
      code: cp -R dist ${WERCKER_OUTPUT_DIR}/

    - script:
      name: copy test artifacts
      code: |
        mkdir -p ${WERCKER_OUTPUT_DIR}/test
        cp -R test/integration ${WERCKER_OUTPUT_DIR}/test/
        cp -R test/system ${WERCKER_OUTPUT_DIR}/test/
        cp -R ansible ${WERCKER_OUTPUT_DIR}/

integration-test:
  box:
    id: wcr.io/oracle/oci-flexvolume-driver-system-test:1.0.0
    registry: https://wcr.io/v2
    username: $DOCKER_REGISTRY_USERNAME
    password: $DOCKER_REGISTRY_PASSWORD
  steps:
    - script:
        name: integration test
        code: |
          cd ./test/integration/
          ./run.sh

system-test:
  box:
    id: wcr.io/oracle/oci-flexvolume-driver-system-test:1.0.0
    registry: https://wcr.io/v2
    username: $DOCKER_REGISTRY_USERNAME
    password: $DOCKER_REGISTRY_PASSWORD
  steps:
    - script:
        name: system test
        code: |
          cd test/system
          ./runner.py

release:
  steps:
    - github-create-release:
      token: $GITHUB_TOKEN
      tag: $GITHUB_RELEASE_VERSION
      title: Application $GITHUB_RELEASE_VERSION
      draft: false

    - github-upload-asset:
      token: $GITHUB_TOKEN
      file: $WERCKER_OUTPUT_DIR/oci
      filename: oci
